<!DOCTYPE html>
<html dir="rtl">
<!-- הסטיילינג והמבנה HTML נשארים זהים, רק מעדכנים את הלוגיקה של הטיפול בתמונה -->
<head>
    <!-- החלק הקודם נשאר זהה -->
</head>
<body>
    <!-- החלק הקודם נשאר זהה -->

    <script>
        let code = '';
        const display = document.getElementById('display');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const successOverlay = document.getElementById('successOverlay');
        const loader = document.getElementById('loader');
        const webhookUrl = 'https://hook.integrator.boost.space/b424j8t6ximfa24pcsy29cw3sjyayffc';
        const imgbbApiKey = '8a5d2394f52a7b0dba4433d8255a7436';

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error('שגיאה בהפעלת המצלמה:', err);
            }
        }

        function captureAndUpload() {
            loader.style.display = 'flex';
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // המרת התמונה ל-Base64 ללא ה-header של Data URL
            const imageBase64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
            
            uploadToImgBB(imageBase64);
        }

        async function uploadToImgBB(base64Image) {
            const formData = new FormData();
            formData.append('image', base64Image);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    // שליחת הקישור לתמונה לוובהוק
                    await sendDataToWebhook(code, data.data.url);
                } else {
                    console.error('שגיאה בהעלאת התמונה:', data.error);
                    loader.style.display = 'none';
                }
            } catch (err) {
                console.error('שגיאה בהעלאת התמונה:', err);
                loader.style.display = 'none';
            }
        }

        async function sendDataToWebhook(code, imageUrl) {
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        imageUrl: imageUrl
                    })
                });
                
                if (response.ok) {
                    loader.style.display = 'none';
                    showSuccessOverlay();
                }
            } catch (err) {
                console.error('שגיאה בשליחת הנתונים:', err);
                loader.style.display = 'none';
            }
        }

        function showSuccessOverlay() {
            successOverlay.style.display = 'block';
        }

        function closeSuccessOverlay() {
            successOverlay.style.display = 'none';
            code = '';
            display.textContent = '';
        }

        document.querySelectorAll('.key').forEach(key => {
            key.addEventListener('click', () => {
                const value = key.textContent;
                
                if (value === 'C') {
                    code = '';
                } else if (value === '⏎') {
                    if (code.length > 0) {
                        captureAndUpload();
                    }
                } else if (code.length < 8) {
                    code += value;
                }
                
                display.textContent = '*'.repeat(code.length);
            });
        });

        startCamera();
    </script>
</body>
</html>
